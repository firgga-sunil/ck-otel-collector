# OpenTelemetry Collector Configuration for Local Development
# Extracted from helm/values.yaml (lines 125-277)

extensions:
  health_check:
    endpoint: "0.0.0.0:13134"
  pprof:
    endpoint: "0.0.0.0:1777"

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: "0.0.0.0:4319"
      http: null

    header_extraction:
      enabled: true
      headers_to_extract:
        - header_name: "ck-domain"
          attribute_name: "ck_domain"

  

processors:
  batch:
    timeout: 1m
    send_batch_size: 16384

  metricsaggregator:
    group_by_labels:
      - "ck_service_name"
      - "agent_version"
      - "ck_namespace"
      - "ck_cluster_name"
      - "path_key"
      - "error_code"
      - "mpk"
      - "fc"
      - "flow_id"
      - "quantile"
      - "ck_domain"
      - "ipk"
      - "tp"

    output_resource_attributes:
      otel_output_metric: "true"
      otel_output_processor: "metricsaggregator"

    aggregation_rules:
      - metric_pattern: "ck_graph_throughput"
        match_type: "strict"
        output_metric_name: "ck_graph_throughput"
        aggregation_type: "sum"
        preserve_original_metrics: false
        output_metric_type: "sum"

      - metric_pattern: "ck_graph_error_count"
        match_type: "strict"
        output_metric_name: "ck_graph_error_count"
        aggregation_type: "sum"
        preserve_original_metrics: false
        output_metric_type: "sum"

      - metric_pattern: "ck_graph_latency"
        match_type: "strict"
        output_metric_name: "ck_graph_latency_nanoseconds"
        aggregation_type: "mean"
        preserve_original_metrics: false
        output_metric_type: "gauge"

      - metric_pattern: "ck_cpu_utilization_percent"
        match_type: "strict"
        output_metric_name: "ck_cpu_utilization_percent"
        aggregation_type: "max"
        preserve_original_metrics: false
        output_metric_type: "gauge"

      - metric_pattern: "ck_method_throughput"
        match_type: "strict"
        output_metric_name: "ck_method_throughput"
        aggregation_type: "sum"
        preserve_original_metrics: false
        output_metric_type: "sum"

      - metric_pattern: "ck_method_error_count"
        match_type: "strict"
        output_metric_name: "ck_method_error_count"
        aggregation_type: "sum"
        preserve_original_metrics: false
        output_metric_type: "sum"

exporters:
  prometheus:
    endpoint: "0.0.0.0:8889"
    send_timestamps: true
    metric_expiration: 180m
    enable_cleanup_api: true
    resource_to_telemetry_conversion:
      enabled: true

  debug:
    verbosity: detailed

service:
  telemetry:
    logs:
      level: info
      development: false
      encoding: json
      disable_caller: false
      disable_stacktrace: false
    metrics:
      level: detailed

  extensions: [health_check, pprof]
  pipelines:
    metrics:
      receivers:
        - otlp
      processors:
        - batch
        - metricsaggregator
      exporters:
        - prometheus
        - debug