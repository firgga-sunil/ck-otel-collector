name: "CI - ck-intel-collector - build, test, release"

permissions:
  contents: write
  packages: write

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-build-workflow]

env:
  DOCKER_IMAGE_PATH: ghcr.io/ckgitrepouser/gcp-demo/ck-intel-collector
  BINARY_NAME: ck-otelcol
  OTEL_HELM_CHART_VERSION: 0.126.0
  GO_VERSION: '1.23'
  BUILDER_VERSION: v0.128.0
  TEST_MODULES: "processor/metricsaggregatorprocessor exporter/prometheusexporter internal/common/testdata internal/coreinternal/testutil"

jobs:

  create-tag:
    name: Create Git Tag
    runs-on: ubuntu-22.04
    outputs:
      previous_tag: ${{ steps.version.outputs.previous_tag }}
      new_tag: ${{ steps.version.outputs.new_tag }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Bump patch version
      id: version
      uses: firgga-sunil/poc-app-of-apps/.github/actions/fetch-and-increment-version@main
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}

  build-and-push:
    name: Build and Push Docker Image
    needs: create-tag
    runs-on: ubuntu-22.04
    outputs:
      image-repository: ${{ steps.set-outputs.outputs.image-repository }}
      image-tag: ${{ steps.set-outputs.outputs.image-tag }}
      image-full: ${{ steps.set-outputs.outputs.image-full }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true

    - name: Install OpenTelemetry Collector Builder
      run: |
        set -e
        echo "ðŸ“¦ Installing OpenTelemetry Collector Builder..."
        go install go.opentelemetry.io/collector/cmd/builder@${{ env.BUILDER_VERSION }}
        builder version
        echo "âœ… Builder installed successfully"

    - name: Build OTEL Collector Binary
      run: |
        set -e
        echo "ðŸ”¨ Building OpenTelemetry Collector binary..."
        builder --config=builder-config.yaml
        
        if [[ ! -f "cmd/${{ env.BINARY_NAME }}" ]]; then
          echo "âŒ Binary not found at cmd/${{ env.BINARY_NAME }}"
          ls -lah cmd/ || true
          exit 1
        fi
        
        echo "âœ… Binary built successfully: cmd/${{ env.BINARY_NAME }}"
        cmd/${{ env.BINARY_NAME }} --version

    - name: Tidy and Test CMD Module
      run: |
        set -e
        echo "ðŸ§¹ Tidying cmd module (created by builder)..."
        cd cmd
        go mod tidy
        echo "âœ… cmd module tidied"
        
        echo "ðŸ§ª Testing cmd module..."
        go test -v ./...
        cd $GITHUB_WORKSPACE

    - name: Set up QEMU for Multi-Platform
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ secrets.GPR_USER }}
        password: ${{ secrets.GPR_TOKEN }}

    - name: Build and Push Multi-Platform Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.multiarch
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ env.DOCKER_IMAGE_PATH }}:${{ needs.create-tag.outputs.new_tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BINARY_NAME=${{ env.BINARY_NAME }}
          BUILDER_VERSION=${{ env.BUILDER_VERSION }}
          OTEL_HELM_CHART_VERSION=${{ env.OTEL_HELM_CHART_VERSION }}

    - name: Verify Image in Registry
      run: |
        set -e
        TAG="${{ needs.create-tag.outputs.new_tag }}"
        IMAGE="${{ env.DOCKER_IMAGE_PATH }}"
        
        echo "ðŸ” Verifying image in registry..."
        docker manifest inspect "${IMAGE}:${TAG}" > /dev/null 2>&1 || exit 1
        echo "âœ… Image successfully pushed to registry"

    - name: Set Build Outputs
      id: set-outputs
      run: |
        VERSION="${{ needs.create-tag.outputs.new_tag }}"
        REPO="${{ env.DOCKER_IMAGE_PATH }}"
        
        echo "image-repository=$REPO" >> $GITHUB_OUTPUT
        echo "image-tag=$VERSION" >> $GITHUB_OUTPUT
        echo "image-full=$REPO:$VERSION" >> $GITHUB_OUTPUT

  create-release:
    name: Create GitHub Release
    needs: [create-tag, build-and-push]
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create GitHub Release
      uses: firgga-sunil/poc-app-of-apps/.github/actions/create-github-release@main
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        new_tag: ${{ needs.create-tag.outputs.new_tag }}
        previous_tag: ${{ needs.create-tag.outputs.previous_tag }}
        image: ${{ env.DOCKER_IMAGE_PATH }}
        mark_latest: true

  build-summary:
    name: Build Summary
    needs: [create-tag, build-and-push, create-release]
    runs-on: ubuntu-22.04
    if: always()
    steps:
    - name: Create Build Summary
      run: |
        IMAGE="${{ env.DOCKER_IMAGE_PATH }}:${{ needs.create-tag.outputs.new_tag }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
        echo "âœ… PIPELINE COMPLETED" >> $GITHUB_STEP_SUMMARY
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Previous Tag:** ${{ needs.create-tag.outputs.previous_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "**New Tag:** ${{ needs.create-tag.outputs.new_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`$IMAGE\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "docker pull $IMAGE" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
