name: "Demo: Build and Optional Deploy"

# Demo pipeline - works only on demo branch
# Uses commit ID for tags, no GitHub releases
#
# ðŸ”„ Workflow Order:
# 1. Validate inputs and branch
# 2. Tidy Go modules (dependency cleanup)
# 3. Run tests (if enabled)
# 4. Build and push Docker image
# 5. Create build summary
# 6. Trigger deploy (if auto-deploy enabled)

permissions:
  contents: read
  packages: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run tests before building'
        required: false
        default: true
        type: boolean
      auto_deploy:
        description: 'Trigger deploy workflow after build'
        required: false
        default: false
        type: boolean
      deploy_provider:
        description: 'Select cloud provider for deployment (only needed if trigger deployment is enabled)'
        required: false
        default: 'aws'
        type: choice
        options:
        - aws
      demo_confirmation:
        description: 'Type "deploy in demo" to confirm deployment to demo (only needed if trigger deployment is enabled)'
        required: false
        default: ''
        type: string


env:
  # Demo environment - hardcoded
  CLUSTER_ENV: demo
  DOCKER_REGISTRY: ghcr.io
  DOCKER_REGISTRY_USERNAME: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
  DOCKER_REGISTRY_TOKEN: ${{ secrets.DOCKER_REGISTRY_TOKEN }}
  BINARY_NAME: ck-intel-collector
  DOCKER_IMAGE_NAME: ck-intel-collector
  OTEL_HELM_CHART_VERSION: 0.126.0
  # Branch restriction
  DEMO_BRANCH: demo
  # Go and Builder versions
  GO_VERSION: '1.23'
  BUILDER_VERSION: v0.128.0
  # Test modules
  TEST_MODULES: "processor/metricsaggregatorprocessor exporter/prometheusexporter internal/common/testdata internal/coreinternal/testutil cmd"

jobs:
  validate-inputs:
    name: Validate Inputs and Branch
    runs-on: ubuntu-22.04
    continue-on-error: false
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Branch
      run: |
        BRANCH_NAME="${{ github.ref_name }}"
        REQUIRED_BRANCH="${{ env.DEMO_BRANCH }}"
        
        echo "ðŸ” Validating branch for demo build..."
        echo "Current branch: $BRANCH_NAME"
        echo "Required branch: $REQUIRED_BRANCH"
        echo ""
        
        if [[ "$BRANCH_NAME" != "$REQUIRED_BRANCH" ]]; then
          echo "âŒ DEMO BUILD NOT ALLOWED ON THIS BRANCH!"
          echo ""
          echo "ðŸš¨ SAFETY CHECK FAILED: Demo builds can only run on '$REQUIRED_BRANCH' branch!"
          echo "   Current branch: '$BRANCH_NAME'"
          echo "   Required branch: '$REQUIRED_BRANCH'"
          echo ""
          echo "ðŸ’¡ Please select '$REQUIRED_BRANCH' branch in the workflow dropdown to continue"
          exit 1
        fi
        
        echo "âœ… Demo branch validated: $BRANCH_NAME"
        
        # Validate other inputs if needed
        echo "âœ… All inputs validated successfully"

  test:
    name: Test
    runs-on: ubuntu-22.04
    needs: validate-inputs
    if: ${{ github.event.inputs.run_tests == 'true' }}
    continue-on-error: true
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Tidy Go Modules
      run: |
        echo "ðŸ§¹ Tidying Go modules for all test modules..."
        echo "Modules to tidy: ${{ env.TEST_MODULES }}"
        echo ""
        
        TIDIED_MODULES=""
        FAILED_TIDY=""
        
        # Tidy each module
        for module in ${{ env.TEST_MODULES }}; do
          echo "Tidying module: $module"
          if cd $module && go mod tidy 2>&1; then
            echo "âœ… $module: TIDIED"
            TIDIED_MODULES="$TIDIED_MODULES $module"
          else
            echo "âŒ $module: TIDY FAILED"
            FAILED_TIDY="$FAILED_TIDY $module"
          fi
          cd $GITHUB_WORKSPACE
        done
        
        echo ""
        echo "=== TIDY SUMMARY ==="
        if [ -n "$TIDIED_MODULES" ]; then
          echo "âœ… TIDIED:$TIDIED_MODULES"
        fi
        if [ -n "$FAILED_TIDY" ]; then
          echo "âŒ TIDY FAILED:$FAILED_TIDY"
          exit 1
        else
          echo "ðŸŽ‰ All modules tidied successfully!"
        fi
        echo ""

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Run tests
      run: |
        # Test all modules as defined in Makefile
        MODULES="${{ env.TEST_MODULES }}"
        FAILED_MODULES=""
        PASSED_MODULES=""
        
        for module_path in $MODULES; do
          module_name=$(basename $module_path)
          echo "Testing $module_path..."
          if cd $module_path && go test -v ./...; then
            PASSED_MODULES="$PASSED_MODULES $module_name"
          else
            FAILED_MODULES="$FAILED_MODULES $module_name"
          fi
          cd $GITHUB_WORKSPACE
        done
        
        echo ""
        echo "=== TEST SUMMARY ==="
        if [ -n "$PASSED_MODULES" ]; then
          echo "âœ… PASSED:$PASSED_MODULES"
        fi
        if [ -n "$FAILED_MODULES" ]; then
          echo "âŒ FAILED:$FAILED_MODULES"
          exit 1
        else
          echo "ðŸŽ‰ All tests passed!"
        fi

  build-and-push:
    name: Build and Push Docker Image
    needs: validate-inputs
    runs-on: ubuntu-22.04
    continue-on-error: false
    outputs:
      image-tag: ${{ steps.set-outputs.outputs.image-tag }}
      image-name: ${{ steps.set-outputs.outputs.image-name }}
      image-repository: ${{ steps.set-outputs.outputs.image-repository }}
      environment: ${{ steps.set-outputs.outputs.environment }}
      commit-id: ${{ steps.set-outputs.outputs.commit-id }}
      version: ${{ steps.set-outputs.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      


    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ env.DOCKER_REGISTRY_USERNAME }}
        password: ${{ env.DOCKER_REGISTRY_TOKEN }}

    - name: Generate image tag
      id: generate-tag
      run: |
        # Use commit ID for demo tags
        COMMIT_ID="${{ github.sha }}"
        SHORT_COMMIT_ID="${COMMIT_ID:0:8}"
        BRANCH_NAME="${{ github.ref_name }}"
        ENVIRONMENT="${{ env.CLUSTER_ENV }}"
        
        # Create demo tag with branch name and commit ID
        TAG="$BRANCH_NAME-$SHORT_COMMIT_ID"
        
        # Set output for Docker build step
        echo "image-tag=$TAG" >> $GITHUB_OUTPUT
        
        echo "Generated tag: $TAG for environment: $ENVIRONMENT (branch: $BRANCH_NAME, commit: $SHORT_COMMIT_ID)"

    - name: Build binary
      run: |
        # Install builder
        go install go.opentelemetry.io/collector/cmd/builder@${{ env.BUILDER_VERSION }}
        
        # Build the collector
        builder --config=builder-config.yaml
        
        echo "Build complete. Binary available at: cmd/$BINARY_NAME"
        
        # Show test status
        if [ "${{ github.event.inputs.run_tests }}" = "true" ]; then
          echo "âœ… Tests were run before building"
        else
          echo "âš ï¸ Tests were skipped (run_tests=false)"
        fi

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.multiarch
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REGISTRY_USERNAME }}/${{ env.CLUSTER_ENV }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.generate-tag.outputs.image-tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      continue-on-error: false

    - name: Set Build Outputs
      id: set-outputs
      run: |
        # Reuse values from generate-tag step
        TAG="${{ steps.generate-tag.outputs.image-tag }}"
        
        # Set outputs for other jobs
        echo "image-tag=$TAG" >> $GITHUB_OUTPUT
        echo "image-name=${{ env.DOCKER_IMAGE_NAME }}" >> $GITHUB_OUTPUT
        echo "image-repository=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REGISTRY_USERNAME }}/${{ env.CLUSTER_ENV }}/${{ env.DOCKER_IMAGE_NAME }}" >> $GITHUB_OUTPUT
        echo "environment=${{ env.CLUSTER_ENV }}" >> $GITHUB_OUTPUT
        echo "commit-id=${TAG#*-}" >> $GITHUB_OUTPUT
        echo "version=$TAG" >> $GITHUB_OUTPUT
        
        echo "âœ… Outputs set successfully"

  build-summary:
    name: Build Summary
    needs: build-and-push
    runs-on: ubuntu-22.04
    continue-on-error: false
    steps:
    - name: Create Build Summary
      run: |
        echo "## ðŸ—ï¸ DEMO BUILD SUMMARY" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Demo Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Docker Image Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Repository**: \`${{ needs.build-and-push.outputs.image-repository }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: \`${{ needs.build-and-push.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Full Image**: \`${{ needs.build-and-push.outputs.image-repository }}:${{ needs.build-and-push.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ·ï¸ Demo Build Info" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: \`${{ needs.build-and-push.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit ID**: \`${{ needs.build-and-push.outputs.commit-id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **No GitHub Release**: Demo builds don't create releases" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Build Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number**: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Registry**: [View Image](https://${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REGISTRY_USERNAME }}/${{ env.CLUSTER_ENV }}/${{ env.DOCKER_IMAGE_NAME }})" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub Repository**: [View Repo](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.auto_deploy }}" = "true" ]; then
          echo "- **Auto-deploy**: âœ… Enabled - Deploying to \`${{ github.event.inputs.deploy_provider }}-${{ env.CLUSTER_ENV }}\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Auto-deploy**: âŒ Disabled - Use deploy workflow to deploy this image" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Manual Deploy**: Use the \`deploy-demo.yml\` workflow with image tag: \`${{ needs.build-and-push.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY

  trigger-deploy:
    name: Trigger Deploy
    needs: build-and-push
    runs-on: ubuntu-22.04
    continue-on-error: false
    if: ${{ github.event.inputs.auto_deploy == 'true' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Trigger Deploy Workflow
      run: |
        # Trigger deploy workflow with build outputs
        gh workflow run deploy-demo.yml \
          --field deploy_provider="${{ github.event.inputs.deploy_provider }}" \
          --field image_tag="${{ needs.build-and-push.outputs.image-tag }}" \
          --field demo_confirmation="${{ github.event.inputs.demo_confirmation }}"
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - name: Create Build Info
      run: |
        cat > build-info.json << EOF
        {
          "image_repository": "${{ needs.build-and-push.outputs.image-repository }}",
          "image_tag": "${{ needs.build-and-push.outputs.image-tag }}",
          "environment": "${{ needs.build-and-push.outputs.environment }}",
          "commit_id": "${{ needs.build-and-push.outputs.commit-id }}",
          "build_number": "${{ github.run_number }}",
          "branch": "${{ github.ref_name }}",
          "commit": "${{ github.sha }}"
        }
        EOF

 